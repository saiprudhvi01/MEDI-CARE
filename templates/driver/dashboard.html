{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Ambulance Driver Dashboard</h2>
    
    <div class="row">
        <!-- Left Column: Driver Info and Map -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Driver Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ current_user.ambulance_driver.name }}</p>
                    <p><strong>License:</strong> {{ current_user.ambulance_driver.license_number }}</p>
                    <p><strong>Hospital:</strong> {{ current_user.ambulance_driver.hospital.name if current_user.ambulance_driver.hospital else 'Not assigned' }}</p>
                    <p><strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if current_user.ambulance_driver.is_available else 'danger' }}">
                            {{ 'Available' if current_user.ambulance_driver.is_available else 'On Duty' }}
                        </span>
                    </p>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Location & Distance</h5>
                    <div id="location-status" class="badge bg-secondary">Updating...</div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 300px; width: 100%;"></div>
                    <div class="p-3">
                        <button id="update-location" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-sync-alt me-2"></i>Update My Location
                        </button>
                        <div class="mb-2">
                            <label class="form-label">Update Distance Traveled (km):</label>
                            <div class="input-group">
                                <input type="number" id="distance" class="form-control" 
                                       placeholder="Enter distance" step="0.1" min="0" value="0">
                                <button class="btn btn-success" id="update-distance">
                                    <i class="fas fa-save me-1"></i> Save
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0 p-2">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Your location will be used to calculate distance to patients.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Requests -->
        <div class="col-md-8">
            <!-- Assigned Requests Section -->
            {% if assigned_requests %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">My Assigned Requests</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Status</th>
                                    <th>Distance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in assigned_requests %}
                                <tr class="assigned-request" 
                                    data-request-id="{{ req.id }}"
                                    data-pickup-lat="{{ req.patient.lat if req.patient else '' }}"
                                    data-pickup-lng="{{ req.patient.lng if req.patient else '' }}"
                                    data-dest-lat="{{ req.hospital_requests.lat if req.hospital_requests else '' }}"
                                    data-dest-lng="{{ req.hospital_requests.lng if req.hospital_requests else '' }}">
                                    <td>
                                        <strong>{{ req.patient.name if req.patient else 'Unknown Patient' }}</strong><br>
                                        <small class="text-muted">{{ req.symptoms|truncate(30) if req.symptoms else 'No symptoms provided' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if req.status == 'completed' else 'warning' }}">
                                            {{ req.status|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if req.distance_covered %}
                                            {{ "%.1f"|format(req.distance_covered) }} km
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if req.status == 'accepted' %}
                                                <button class="btn btn-primary start-trip" data-request-id="{{ req.id }}">
                                                    <i class="fas fa-play"></i> Start Trip
                                                </button>
                                            {% elif req.status == 'in_transit' %}
                                                <button class="btn btn-success complete-trip" data-request-id="{{ req.id }}">
                                                    <i class="fas fa-flag-checkered"></i> Complete
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-info view-details" data-request-id="{{ req.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Emergency Ambulance Requests -->
            {% if ambulance_requests %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">ðŸš¨ Emergency Ambulance Requests</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Emergency</th>
                                    <th>Location</th>
                                    <th>Contact</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in ambulance_requests %}
                                <tr class="ambulance-request-row" 
                                    data-request-id="{{ req.id }}"
                                    data-location="{{ req.patient_location_text }}">
                                    <td>
                                        <strong>{{ req.patient.name if req.patient else 'Unknown Patient' }}</strong><br>
                                        <small class="text-primary">Emergency Request</small>
                                    </td>
                                    <td>
                                        <strong class="text-danger">{{ req.emergency_description|truncate(40) if req.emergency_description else 'Emergency' }}</strong>
                                    </td>
                                    <td>
                                        <small>{{ req.patient_location_text|truncate(50) if req.patient_location_text else 'No location provided' }}</small>
                                    </td>
                                    <td>
                                        <small>{{ req.contact_phone if req.contact_phone else 'No contact' }}</small>
                                    </td>
                                    <td>
                                        <small>{{ req.created_at.strftime('%H:%M') if req.created_at else '' }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-success accept-ambulance-request" 
                                                    data-request-id="{{ req.id }}"
                                                    {% if not current_user.ambulance_driver.is_available %}disabled{% endif %}>
                                                <i class="fas fa-check me-1"></i> Accept
                                            </button>
                                            <button class="btn btn-secondary reject-ambulance-request" 
                                                    data-request-id="{{ req.id }}">
                                                <i class="fas fa-times me-1"></i> Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Hospital Ambulance Requests -->
            {% if hospital_requests %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Hospital Ambulance Requests</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Location</th>
                                    <th>Distance</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in hospital_requests %}
                                <tr class="request-row" 
                                    data-request-id="{{ req.id }}"
                                    data-lat="{{ req.patient.lat }}" 
                                    data-lng="{{ req.patient.lng }}" 
                                    data-address="{{ req.patient.address }}">
                                    <td>
                                        <strong>{{ req.patient.name if req.patient else 'Unknown Patient' }}</strong><br>
                                        <small class="text-muted">{{ req.symptoms|truncate(30) if req.symptoms else 'No symptoms provided' }}</small>
                                    </td>
                                    <td>
                                        {% if req.patient and req.patient.address %}
                                            {{ req.patient.address|truncate(25) }}<br>
                                            <small class="text-muted">
                                                {{ req.patient.city }}{% if req.patient.city and req.patient.state %}, {% endif %}{{ req.patient.state if req.patient.state else '' }}
                                            </small>
                                        {% else %}
                                            <span class="text-muted">No address provided</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="distance">-</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary accept-request" 
                                                data-request-id="{{ req.id }}"
                                                {% if not current_user.ambulance_driver.is_available %}disabled{% endif %}>
                                            <i class="fas fa-ambulance me-1"></i> Accept
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- No Requests Available -->
            {% if not ambulance_requests and not hospital_requests %}
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Available Requests</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No ambulance requests available at the moment.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

    <!-- SweetAlert for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jQuery (required for some AJAX operations) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // Global variables
        let map;
        let marker; // Driver marker
        let driverMarker;
        let directionsService;
        let directionsRenderer;
        let currentRequestMarker = null;
        let watchId = null;
        let currentRequestId = null;
        let currentPolyline = null;
        let currentPosition = null;
        let currentRequest = null;
        
        // Function to get CSRF token from meta tag
        function getCSRFToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                return metaTag.getAttribute('content');
            }
            console.error('CSRF token meta tag not found');
            return null;
        }
        
        // Set CSRF token in AJAX requests (only if jQuery is available)
        if (typeof $ !== 'undefined') {
            $.ajaxSetup({
                beforeSend: function(xhr) {
                    const token = getCSRFToken();
                    if (token) {
                        xhr.setRequestHeader('X-CSRF-TOKEN', token);
                    }
                }
            });
        }
        
        // Initialize the map when the Google Maps API is loaded
        function initMap() {
            // Set default location (center of India)
            const defaultLocation = { lat: 20.5937, lng: 78.9629 };
            
            // Initialize the map
            if (typeof google !== 'undefined' && google.maps) {
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: defaultLocation,
                    mapTypeId: 'roadmap',
                    streetViewControl: false,
                    fullscreenControl: true,
                    mapTypeControl: false
                });
                
                // Initialize services
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.8,
                        strokeWeight: 4
                    }
                });
                
                // Set up event listeners after map is initialized
                setupEventListeners();
                
                // Start tracking the driver's location
                startLocationTracking();
            } else {
                console.error('Google Maps API not loaded');
            }
            
            // Check for any active requests
            checkActiveRequest();
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Update location button
            document.getElementById('update-location').addEventListener('click', updateCurrentLocation);
            
            // Update distance button
            document.getElementById('update-distance').addEventListener('click', updateDistance);
            
            // Accept request buttons - Use event delegation
            document.addEventListener('click', function(e) {
                console.log('Click detected on:', e.target);
                
                // Handle accept ambulance request
                if (e.target.matches('.accept-ambulance-request') || e.target.closest('.accept-ambulance-request')) {
                    e.preventDefault();
                    console.log('Accept ambulance request button clicked');
                    const button = e.target.matches('.accept-ambulance-request') ? e.target : e.target.closest('.accept-ambulance-request');
                    if (!button.disabled) {
                        const requestId = button.getAttribute('data-request-id');
                        console.log('Request ID:', requestId);
                        acceptAmbulanceRequest(requestId);
                    } else {
                        console.log('Button is disabled');
                    }
                    return;
                }
                
                // Handle reject ambulance request
                if (e.target.matches('.reject-ambulance-request') || e.target.closest('.reject-ambulance-request')) {
                    e.preventDefault();
                    console.log('Reject ambulance request button clicked');
                    const button = e.target.matches('.reject-ambulance-request') ? e.target : e.target.closest('.reject-ambulance-request');
                    const requestId = button.getAttribute('data-request-id');
                    console.log('Reject Request ID:', requestId);
                    rejectAmbulanceRequest(requestId);
                    return;
                }
                
                // Handle accept request (regular hospital requests)
                if (e.target.matches('.accept-request') || e.target.closest('.accept-request')) {
                    e.preventDefault();
                    const button = e.target.matches('.accept-request') ? e.target : e.target.closest('.accept-request');
                    if (!button.disabled) {
                        const requestId = button.getAttribute('data-request-id');
                        acceptRequest(requestId);
                    }
                    return;
                }
                
                // Handle start trip
                if (e.target.closest('.start-trip')) {
                    const button = e.target.closest('.start-trip');
                    const requestId = button.getAttribute('data-request-id');
                    updateRequestStatus(requestId, 'in_transit');
                }
                
                // Handle complete trip
                if (e.target.matches('.complete-trip') || e.target.closest('.complete-trip')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const button = e.target.matches('.complete-trip') ? e.target : e.target.closest('.complete-trip');
                    
                    if (button.disabled) {
                        console.log('Complete button is disabled');
                        return;
                    }
                    
                    // Disable button to prevent multiple clicks
                    button.disabled = true;
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    
                    const requestId = button.getAttribute('data-request-id');
                    console.log('Completing request:', requestId);
                    
                    // Add a small delay to show the loading state
                    setTimeout(() => {
                        completeRequest(requestId)
                            .then(() => {
                                // Show success message
                                Swal.fire('Request Completed', 'The request has been successfully completed.', 'success');
                            })
                            .catch(error => {
                                // Show error message
                                console.error('Error completing request:', error);
                                Swal.fire('Error Completing Request', 'An error occurred while completing the request.', 'error');
                            })
                            .finally(() => {
                                // Re-enable button in case of error
                                button.disabled = false;
                                button.innerHTML = originalText;
                                
                                // Reload the page to show updated status
                                setTimeout(() => window.location.reload(), 1500);
                            });
                    }, 100);
                }
                
                // Handle view details
                if (e.target.closest('.view-details')) {
                    const button = e.target.closest('.view-details');
                    const requestId = button.getAttribute('data-request-id');
                    viewRequestDetails(requestId);
                }
            });
        }
        
        // Start tracking the driver's location
        function startLocationTracking() {
            if (navigator.geolocation) {
                // First, get the current position
                updateCurrentLocation();
                
                // Then set up a watch for continuous updates
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        updateDriverPosition(pos);
                        updateLocationStatus('success', 'Location updated');
                        
                        // If we have a current request, update its position
                        if (currentRequest) {
                            updateRequestPosition(pos.lat, pos.lng);
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let message = 'Error getting location';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'Location access was denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'Location information is unavailable';
                                break;
                            case error.TIMEOUT:
                                message = 'Location request timed out';
                                break;
                        }
                        updateLocationStatus('error', message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                updateLocationStatus('error', 'Geolocation is not supported by your browser');
            }
        }
        
        // Update the driver's position on the map
        function updateDriverPosition(pos) {
            currentPosition = pos;
            
            // Update the map center
            map.setCenter(pos);
            
            // Update or create the marker
            if (!marker) {
                marker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: 'Your Location',
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    animation: google.maps.Animation.DROP
                });
            } else {
                marker.setPosition(pos);
            }
            
            // Calculate distances to all requests
            calculateDistancesToRequests();
        }
        
        // Update the location status indicator
        function updateLocationStatus(status, message) {
            const statusEl = document.getElementById('location-status');
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.className = 'badge';
            
            switch(status) {
                case 'success':
                    statusEl.classList.add('bg-success');
                    break;
                case 'error':
                    statusEl.classList.add('bg-danger');
                    break;
                case 'updating':
                    statusEl.classList.add('bg-warning');
                    break;
                default:
                    statusEl.classList.add('bg-secondary');
            }
        }
        
        // Calculate distances from driver to all requests
        function calculateDistancesToRequests() {
            if (!currentPosition) return;
            
            document.querySelectorAll('.request-row').forEach(row => {
                const lat = parseFloat(row.getAttribute('data-lat'));
                const lng = parseFloat(row.getAttribute('data-lng'));
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const distance = calculateDistance(
                        currentPosition.lat, 
                        currentPosition.lng,
                        lat,
                        lng
                    );
                    
                    const distanceEl = row.querySelector('.distance');
                    if (distanceEl) {
                        distanceEl.textContent = `${distance.toFixed(1)} km`;
                    }
                    
                    // Add a marker for the request if it doesn't exist
                    if (!row.marker) {
                        row.marker = new google.maps.Marker({
                            position: { lat, lng },
                            map: map,
                            title: 'Patient Location',
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                                scaledSize: new google.maps.Size(30, 30)
                            }
                        });
                    }
                }
            });
        }
        
        // Calculate distance between two points in km (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Update the driver's current location
        function updateCurrentLocation() {
            updateLocationStatus('updating', 'Updating location...');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update the driver's position on the map
                        updateDriverPosition(pos);
                        updateLocationStatus('success', 'Location updated');
                        
                        // If we have a current request, update its position
                        if (currentRequest) {
                            updateRequestPosition(pos.lat, pos.lng);
                        }
                        
                        // Update the driver's location in the database
                        updateDriverLocation(pos.lat, pos.lng);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        let message = 'Error getting location';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'Location access was denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'Location information is unavailable';
                                break;
                            case error.TIMEOUT:
                                message = 'Location request timed out';
                                break;
                        }
                        
                        updateLocationStatus('error', message);
                        
                        // Show error to user
                        Swal.fire({
                            icon: 'error',
                            title: 'Location Error',
                            text: message,
                            confirmButtonText: 'OK'
                        });
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateLocationStatus('error', 'Geolocation is not supported by your browser');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Not Supported',
                    text: 'Geolocation is not supported by your browser',
                    confirmButtonText: 'OK'
                });
            }
        }
        
        // Function to get CSRF token from meta tag
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }
        
        // Update the driver's location in the database
        function updateDriverLocation(lat, lng) {
            fetch('/api/driver/location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCSRFToken()
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update driver location:', data.message);
                }
            })
            .catch(error => {
                console.error('Error updating driver location:', error);
            });
        }
        
        // Update the position for the current request
        function updateRequestPosition(lat, lng) {
            if (!currentRequest) return;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            fetch(`/api/requests/${currentRequest.id}/position`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                    csrf_token: csrfToken
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update request position:', data.message);
                }
            })
            .catch(error => {
                console.error('Error updating request position:', error);
            });
        }
        
        // Accept a new request
        function acceptRequest(requestId) {
            if (!confirm('Are you sure you want to accept this request?')) {
                return;
            }
            
            updateLocationStatus('updating', 'Accepting request...');
            
            fetch(`/api/requests/${requestId}/accept`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI to show the request is now assigned
                    const requestRow = document.querySelector(`.request-row[data-request-id="${requestId}"]`);
                    if (requestRow) {
                        requestRow.remove();
                    }
                    
                    // Add to assigned requests
                    addAssignedRequest(data.request);
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Request Accepted',
                        text: 'You have accepted the ambulance request',
                        confirmButtonText: 'OK'
                    });
                    
                    // Set as current request
                    setCurrentRequest(data.request);
                } else {
                    throw new Error(data.message || 'Failed to accept request');
                }
            })
            .catch(error => {
                console.error('Error accepting request:', error);
                updateLocationStatus('error', 'Failed to accept request');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to accept request',
                    confirmButtonText: 'OK'
                });
            });
        }
        
        // Add a request to the assigned requests section
        function addAssignedRequest(request) {
            const assignedRequestsContainer = document.querySelector('.assigned-requests');
            if (!assignedRequestsContainer) return;
            
            const row = document.createElement('tr');
            row.className = 'assigned-request';
            row.setAttribute('data-request-id', request.id);
            row.setAttribute('data-pickup-lat', request.patient.lat);
            row.setAttribute('data-pickup-lng', request.patient.lng);
            row.setAttribute('data-dest-lat', request.hospital.lat);
            row.setAttribute('data-dest-lng', request.hospital.lng);
            
            row.innerHTML = `
                <td>
                    <strong>${request.patient.name}</strong><br>
                    <small class="text-muted">${request.symptoms || 'No symptoms provided'}</small>
                </td>
                <td>
                    <span class="badge bg-warning">${request.status.replace('_', ' ').toUpperCase()}</span>
                </td>
                <td>
                    <span class="distance">-</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary start-trip" data-request-id="${request.id}">
                            <i class="fas fa-play"></i> Start Trip
                        </button>
                        <button class="btn btn-info view-details" data-request-id="${request.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Add to the top of the table
            const tbody = assignedRequestsContainer.querySelector('tbody');
            if (tbody) {
                tbody.insertBefore(row, tbody.firstChild);
            } else {
                assignedRequestsContainer.appendChild(row);
            }
            
            // If this is the first assigned request, show the section
            document.querySelector('.assigned-requests-section').style.display = 'block';
        }
        
        // Set the current active request
        function setCurrentRequest(request) {
            currentRequest = request;
            
            // Update UI to show this is the active request
            document.querySelectorAll('.assigned-request').forEach(row => {
                const rowId = row.getAttribute('data-request-id');
                if (rowId === String(request.id)) {
                    row.classList.add('table-active');
                    
                    // Update the status badge
                    const statusBadge = row.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-primary';
                        statusBadge.textContent = 'IN PROGRESS';
                    }
                    
                    // Update the action buttons
                    const actionsDiv = row.querySelector('.btn-group');
                    if (actionsDiv) {
                        actionsDiv.innerHTML = `
                            <button class="btn btn-success complete-trip" data-request-id="${request.id}">
                                <i class="fas fa-flag-checkered"></i> Complete
                            </button>
                            <button class="btn btn-info view-details" data-request-id="${request.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        `;
                    }
                    
                    // Show the route on the map
                    showRoute(
                        currentPosition || { lat: parseFloat(row.getAttribute('data-pickup-lat')), lng: parseFloat(row.getAttribute('data-pickup-lng')) },
                        { lat: parseFloat(row.getAttribute('data-dest-lat')), lng: parseFloat(row.getAttribute('data-dest-lng')) }
                    );
                } else {
                    row.classList.remove('table-active');
                }
            });
        }
        
        // Show route between two points on the map
        function showRoute(origin, destination) {
            try {
                if (!origin || !destination) {
                    console.warn('showRoute: Missing origin or destination');
                    return;
                }
                
                // Initialize directionsRenderer if not already done
                if (!window.directionsRenderer) {
                    window.directionsRenderer = new google.maps.DirectionsRenderer({
                        map: window.map,
                        suppressMarkers: false,
                        polylineOptions: {
                            strokeColor: '#4285F4',
                            strokeWeight: 5,
                            strokeOpacity: 0.8
                        }
                    });
                }
                
                // Initialize directionsService if not already done
                if (!window.directionsService) {
                    window.directionsService = new google.maps.DirectionsService();
                }
                
                // Clear any existing routes
                window.directionsRenderer.setDirections({ routes: [] });
                
                // Make sure we have valid origin and destination objects
                const originObj = typeof origin === 'object' ? origin : { lat: parseFloat(origin.lat), lng: parseFloat(origin.lng) };
                const destObj = typeof destination === 'object' ? destination : { lat: parseFloat(destination.lat), lng: parseFloat(destination.lng) };
                
                // Request directions
                window.directionsService.route(
                    {
                        origin: originObj,
                        destination: destObj,
                        travelMode: google.maps.TravelMode.DRIVING,
                        provideRouteAlternatives: false
                    },
                    (response, status) => {
                        if (status === 'OK' && response && response.routes && response.routes.length > 0) {
                            try {
                                window.directionsRenderer.setDirections(response);
                                
                                // Calculate and display distance if route has legs
                                const route = response.routes[0];
                                if (route.legs && route.legs.length > 0) {
                                    let distance = 0;
                                    route.legs.forEach(leg => {
                                        if (leg.distance && leg.distance.value) {
                                            distance += leg.distance.value; // in meters
                                        }
                                    });
                                    
                                    // Update the distance in the UI if we have a valid distance
                                    if (distance > 0) {
                                        const distanceKm = (distance / 1000).toFixed(1);
                                        document.querySelectorAll('.assigned-request.table-active .distance').forEach(el => {
                                            el.textContent = `${distanceKm} km`;
                                        });
                                        
                                        // Update the distance input field
                                        const distanceInput = document.getElementById('distance');
                                        if (distanceInput) {
                                            distanceInput.value = distanceKm;
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('Error processing directions response:', e);
                            }
                        } else {
                            console.warn('Directions request failed with status:', status);
                            // Fallback to just showing markers if route fails
                            if (window.map && origin && destination) {
                                new google.maps.Marker({
                                    position: originObj,
                                    map: window.map,
                                    title: 'Pickup Location'
                                });
                                
                                new google.maps.Marker({
                                    position: destObj,
                                    map: window.map,
                                    title: 'Destination'
                                });
                                
                                // Fit bounds to show both points
                                const bounds = new google.maps.LatLngBounds();
                                bounds.extend(originObj);
                                bounds.extend(destObj);
                                window.map.fitBounds(bounds);
                            }
                        }
                    }
                );
            } catch (error) {
                console.error('Error in showRoute:', error);
            }
        }
        
        // Update the status of a request
        function updateRequestStatus(requestId, status) {
            updateLocationStatus('updating', 'Updating request status...');
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            fetch(`/api/requests/${requestId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 
                    status: status,
                    csrf_token: csrfToken 
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI based on the new status
                    const row = document.querySelector(`.assigned-request[data-request-id="${requestId}"]`);
                    if (row) {
                        const statusBadge = row.querySelector('.badge');
                        if (statusBadge) {
                            statusBadge.textContent = status.replace('_', ' ').toUpperCase();
                            
                            if (status === 'in_transit') {
                                statusBadge.className = 'badge bg-primary';
                                
                                // Update the action buttons
                                const actionsDiv = row.querySelector('.btn-group');
                                if (actionsDiv) {
                                    actionsDiv.innerHTML = `
                                        <button class="btn btn-success complete-trip" data-request-id="${requestId}">
                                            <i class="fas fa-flag-checkered"></i> Complete
                                        </button>
                                        <button class="btn btn-info view-details" data-request-id="${requestId}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    `;
                                }
                                
                                // Set as current request
                                if (data.request) {
                                    setCurrentRequest(data.request);
                                }
                            }
                        }
                    }
                    
                    updateLocationStatus('success', 'Status updated');
                } else {
                    throw new Error(data.message || 'Failed to update status');
                }
            })
            .catch(error => {
                console.error('Error updating request status:', error);
                updateLocationStatus('error', 'Failed to update status');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to update request status',
                    confirmButtonText: 'OK'
                });
            });
        }
        
        // Complete a request
        function completeRequest(requestId) {
            // Get the request details
            const row = document.querySelector(`.assigned-request[data-request-id="${requestId}"]`);
            if (!row) return;
            
            // Calculate time taken (in minutes)
            const startTime = new Date(row.dataset.startTime);
            const currentTime = new Date();
            const timeTakenMinutes = Math.round((currentTime - startTime) / 60000);
            
            // Get the distance from the input field or calculate it
            let distance = document.getElementById('distance')?.value;
            if (!distance || isNaN(distance) || distance <= 0) {
                // If no distance entered, try to calculate it
                const pickupLat = parseFloat(row.dataset.pickupLat);
                const pickupLng = parseFloat(row.dataset.pickupLng);
                const destLat = parseFloat(row.dataset.destLat);
                const destLng = parseFloat(row.dataset.destLng);
                
                if (!isNaN(pickupLat) && !isNaN(pickupLng) && !isNaN(destLat) && !isNaN(destLng)) {
                    distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                } else {
                    distance = 0;
                }
            }
            
            // Show confirmation dialog with time and distance
            Swal.fire({
                title: 'Complete Trip',
                html: `
                    <div class="text-start">
                        <p>Please confirm the trip details:</p>
                        <p>â€¢ Time taken: <strong>${timeTakenMinutes} minutes</strong></p>
                        <div class="mb-3">
                            <label for="distance-traveled" class="form-label">Distance Traveled (km):</label>
                            <input type="number" class="form-control" id="distance-traveled" 
                                   value="${parseFloat(distance).toFixed(2)}" step="0.1" min="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes (optional):</label>
                            <textarea class="form-control" id="trip-notes" rows="2" 
                                     placeholder="Any additional notes about the trip"></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Complete Trip',
                cancelButtonText: 'Cancel',
                focusConfirm: false,
                preConfirm: () => {
                    const finalDistance = parseFloat(document.getElementById('distance-traveled').value);
                    if (isNaN(finalDistance) || finalDistance <= 0) {
                        Swal.showValidationMessage('Please enter a valid distance');
                        return false;
                    }
                    return {
                        distance: finalDistance,
                        time_taken: timeTakenMinutes,
                        notes: document.getElementById('trip-notes').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { distance, time_taken, notes } = result.value;
                    const csrfToken = getCSRFToken();
                    
                    // Show loading state
                    Swal.fire({
                        title: 'Completing Trip...',
                        text: 'Please wait while we update the records.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Send completion data to server
                    fetch(`/api/requests/${requestId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ 
                            distance: distance,
                            time_taken: time_taken,
                            notes: notes,
                            csrf_token: csrfToken 
                        }),
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.message || 'Failed to complete request');
                        }
                        
                        // Update the UI
                        if (row) {
                            // Update status badge
                            const statusBadge = row.querySelector('.badge');
                            if (statusBadge) {
                                statusBadge.className = 'badge bg-success';
                                statusBadge.textContent = 'COMPLETED';
                            }
                            
                            // Update distance display
                            const distanceCell = row.querySelector('td:nth-child(3)');
                            if (distanceCell) {
                                distanceCell.innerHTML = `${distance.toFixed(1)} km <small class="text-muted">(${time_taken} min)</small>`;
                            }
                            
                            // Remove action buttons
                            const actionsDiv = row.querySelector('.btn-group');
                            if (actionsDiv) {
                                actionsDiv.innerHTML = `
                                    <button class="btn btn-info view-details" data-request-id="${requestId}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                `;
                            }
                            
                            // Remove active class
                            row.classList.remove('table-active');
                        }
                        
                        // Clear current request and map
                        currentRequest = null;
                        if (window.directionsRenderer) {
                            window.directionsRenderer.setDirections({ routes: [] });
                        }
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Trip Completed!',
                            html: `
                                <p>You have successfully completed the trip.</p>
                                <div class="text-start mt-3">
                                    <p><strong>Trip Summary:</strong></p>
                                    <p>â€¢ Distance: ${distance.toFixed(2)} km</p>
                                    <p>â€¢ Time Taken: ${time_taken} minutes</p>
                                    ${notes ? `<p class="mt-2"><strong>Notes:</strong> ${notes}</p>` : ''}
                                </div>
                            `,
                            confirmButtonText: 'OK'
                        });
                        
                        // Reload the page after a short delay
                        setTimeout(() => window.location.reload(), 2000);
                    })
                    .catch(error => {
                        console.error('Error completing trip:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message || 'Failed to complete trip. Please try again.',
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        }
        
        // View request details
        function viewRequestDetails(requestId) {
            // Find the request in the assigned requests
            const row = document.querySelector(`.assigned-request[data-request-id="${requestId}"]`);
            if (!row) return;
            
            // Get request data from the row
            const patientName = row.querySelector('td:first-child strong').textContent;
            const symptoms = row.querySelector('td:first-child small').textContent;
            const status = row.querySelector('.badge').textContent;
            const distance = row.querySelector('.distance').textContent;
            
            // Show details in a modal
            Swal.fire({
                title: 'Request Details',
                html: `
                    <div class="text-start">
                        <p><strong>Patient:</strong> ${patientName}</p>
                        <p><strong>Symptoms:</strong> ${symptoms || 'None provided'}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${status === 'COMPLETED' ? 'success' : 'primary'}">${status}</span></p>
                        <p><strong>Distance:</strong> ${distance}</p>
                        <hr>
                        <p class="text-muted">Request ID: ${requestId}</p>
                    </div>
                `,
                confirmButtonText: 'Close',
                showCloseButton: true
            });
        }
        
        // Update distance for the current request
        function updateDistance() {
            const distanceInput = document.getElementById('distance');
            const distance = parseFloat(distanceInput.value);
            
            if (isNaN(distance) || distance <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Distance',
                    text: 'Please enter a valid distance greater than 0',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            if (!currentRequest) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Active Request',
                    text: 'You need to have an active request to update distance',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            updateLocationStatus('updating', 'Updating distance...');
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            fetch(`/api/requests/${currentRequest.id}/distance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 
                    distance: distance,
                    csrf_token: csrfToken 
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the distance in the UI
                    document.querySelectorAll('.assigned-request.table-active .distance').forEach(el => {
                        el.textContent = `${distance.toFixed(1)} km`;
                    });
                    
                    // Clear the input
                    distanceInput.value = '';
                    
                    updateLocationStatus('success', 'Distance updated');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Distance Updated',
                        text: `Distance updated to ${distance.toFixed(1)} km`,
                        confirmButtonText: 'OK'
                    });
                } else {
                    throw new Error(data.message || 'Failed to update distance');
                }
            })
            .catch(error => {
                console.error('Error updating distance:', error);
                updateLocationStatus('error', 'Failed to update distance');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to update distance',
                    confirmButtonText: 'OK'
                });
            });
        }
        
        // Check for active requests when the page loads
        function checkActiveRequest() {
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            fetch('/api/driver/active-request', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.request) {
                    // Add to assigned requests if not already there
                    if (!document.querySelector(`.assigned-request[data-request-id="${data.request.id}"]`)) {
                        addAssignedRequest(data.request);
                    }
                    
                    // Set as current request
                    setCurrentRequest(data.request);
                }
            })
            .catch(error => {
                console.error('Error checking active request:', error);
            });
        }
        
        // Initialize when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization');
            
            // Test if buttons exist
            const acceptButtons = document.querySelectorAll('.accept-ambulance-request');
            const rejectButtons = document.querySelectorAll('.reject-ambulance-request');
            console.log('Found accept buttons:', acceptButtons.length);
            console.log('Found reject buttons:', rejectButtons.length);
            
            // Add direct click listeners to buttons for testing
            acceptButtons.forEach(button => {
                console.log('Adding click listener to accept button:', button);
                button.addEventListener('click', function(e) {
                    console.log('Direct accept button clicked!');
                    e.preventDefault();
                    const requestId = this.getAttribute('data-request-id');
                    console.log('Direct click Request ID:', requestId);
                    acceptAmbulanceRequest(requestId);
                });
            });
            
            rejectButtons.forEach(button => {
                console.log('Adding click listener to reject button:', button);
                button.addEventListener('click', function(e) {
                    console.log('Direct reject button clicked!');
                    e.preventDefault();
                    const requestId = this.getAttribute('data-request-id');
                    console.log('Direct reject Request ID:', requestId);
                    rejectAmbulanceRequest(requestId);
                });
            });
            
            // Check for active requests
            checkActiveRequest();
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize map - use dummy map if Google Maps is not available
            initializeMap();
        });
        
        // Initialize map or create dummy map
        function initializeMap() {
            if (typeof google !== 'undefined' && google.maps) {
                initMap();
            } else {
                // Create a dummy map placeholder
                createDummyMap();
            }
        }
        
        // Create a dummy map for demonstration
        function createDummyMap() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;
            
            mapContainer.innerHTML = `
                <div style="
                    width: 100%; 
                    height: 100%; 
                    background: linear-gradient(45deg, #e3f2fd, #bbdefb);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    overflow: hidden;
                    border-radius: 8px;
                ">
                    <!-- Grid lines for map effect -->
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-image: 
                            linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
                        background-size: 40px 40px;
                    "></div>
                    
                    <!-- Driver location marker -->
                    <div id="driverMarker" style="
                        position: absolute;
                        width: 20px;
                        height: 20px;
                        background: #2196f3;
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        top: 45%;
                        left: 45%;
                        transform: translate(-50%, -50%);
                        animation: pulse 2s infinite;
                    " title="Your Location"></div>
                    
                    <!-- Patient locations -->
                    <div class="patient-marker" style="
                        position: absolute;
                        width: 16px;
                        height: 16px;
                        background: #f44336;
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        top: 30%;
                        left: 60%;
                        transform: translate(-50%, -50%);
                    " title="Patient Location"></div>
                    
                    <div class="patient-marker" style="
                        position: absolute;
                        width: 16px;
                        height: 16px;
                        background: #ff9800;
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        top: 65%;
                        left: 35%;
                        transform: translate(-50%, -50%);
                    " title="Emergency Location"></div>
                    
                    <!-- Map labels -->
                    <div style="
                        position: absolute;
                        bottom: 10px;
                        left: 10px;
                        background: rgba(255,255,255,0.9);
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <div style="width: 12px; height: 12px; background: #2196f3; border-radius: 50%; margin-right: 8px;"></div>
                            <span>Your Location</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <div style="width: 12px; height: 12px; background: #f44336; border-radius: 50%; margin-right: 8px;"></div>
                            <span>Patients</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 12px; height: 12px; background: #ff9800; border-radius: 50%; margin-right: 8px;"></div>
                            <span>Emergency</span>
                        </div>
                    </div>
                    
                    <div style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(255,255,255,0.9);
                        padding: 6px 10px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                        color: #666;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    ">Demo Map View</div>
                </div>
                
                <style>
                    @keyframes pulse {
                        0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
                        70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
                        100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
                    }
                </style>
            `;
            
            // Update location status
            updateLocationStatus('success', 'Demo mode active');
        }
        
        // This function is called by the Google Maps API when it's loaded
        function initMap() {
            // Set default location (center of India)
            const defaultLocation = { lat: 20.5937, lng: 78.9629 };
            
            // Initialize the map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: defaultLocation,
                mapTypeId: 'roadmap',
                streetViewControl: false,
                fullscreenControl: true,
                mapTypeControl: false
            });
            
            // Initialize services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeWeight: 4
                }
            });
            directionsRenderer.setMap(map);
            
            // Set up event listeners
            setupEventListeners();
            
            // Start tracking location
            startLocationTracking();
            
            // Check for any active requests
            checkActiveRequest();
        }
        
        // Function to calculate distances to all requests and update the UI
        function calculateDistances(driverPos) {
            if (!driverPos || !driverPos.lat || !driverPos.lng) {
                console.error('Invalid driver position:', driverPos);
                return;
            }

            document.querySelectorAll('.request-row').forEach(row => {
                const patientLat = parseFloat(row.getAttribute('data-lat'));
                const patientLng = parseFloat(row.getAttribute('data-lng'));
                
                if (!isNaN(patientLat) && !isNaN(patientLng)) {
                    try {
                        const distance = calculateDistance(
                            driverPos.lat, 
                            driverPos.lng, 
                            patientLat, 
                            patientLng
                        );
                        
                        // Update the distance in the table
                        const distanceElement = row.querySelector('.distance');
                        if (distanceElement) {
                            distanceElement.textContent = `${distance.toFixed(1)} km`;
                            distanceElement.setAttribute('data-distance', distance.toFixed(2));
                        }
                        
                        // Add a marker for the patient if map is available
                        if (typeof google !== 'undefined' && google.maps) {
                            new google.maps.Marker({
                                position: { lat: patientLat, lng: patientLng },
                                map: map,
                                title: row.getAttribute('data-address') || 'Patient Location',
                                icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                            });
                        }
                    } catch (error) {
                        console.error('Error calculating distance:', error);
                    }
                }
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula to calculate distance between two points
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }
        
        function acceptRequest(requestId) {
            if (!confirm('Are you sure you want to accept this request?')) {
                return;
            }
            
            // Get the request element
            const requestElement = document.querySelector(`.request-row[data-request-id="${requestId}"]`);
            if (!requestElement) {
                showAlert('Request not found', 'danger');
                return;
            }
            
            // Get the patient's location
            const patientLat = parseFloat(requestElement.getAttribute('data-lat'));
            const patientLng = parseFloat(requestElement.getAttribute('data-lng'));
            
            // Show loading state
            const acceptBtn = requestElement.querySelector('.accept-request');
            const originalBtnText = acceptBtn.innerHTML;
            acceptBtn.disabled = true;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Get current location for the driver
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const driverLat = position.coords.latitude;
                        const driverLng = position.coords.longitude;
                        
                        // Calculate distance
                        const distance = calculateDistance(
                            driverLat, driverLng,
                            patientLat, patientLng
                        );
                        
                        // Send accept request with locations
                        fetch(`/api/requests/${requestId}/accept`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                driver_lat: driverLat,
                                driver_lng: driverLng,
                                distance: distance,
                                csrf_token: csrfToken
                            }),
                            credentials: 'same-origin'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showAlert('Request accepted successfully!', 'success');
                                // Reload the page after a short delay
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                throw new Error(data.message || 'Failed to accept request');
                            }
                        })
                        .catch(error => {
                            console.error('Error accepting request:', error);
                            showAlert('Error: ' + error.message, 'danger');
                            // Reset button state
                            acceptBtn.disabled = false;
                            acceptBtn.innerHTML = originalBtnText;
                        });
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        showAlert('Could not get your location. Please enable location services and try again.', 'danger');
                        // Reset button state
                        acceptBtn.disabled = false;
                        acceptBtn.innerHTML = originalBtnText;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showAlert('Geolocation is not supported by your browser', 'danger');
                // Reset button state
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = originalBtnText;
            }
        }
        
        function updateDistance() {
            const distanceInput = document.getElementById('distance');
            const distance = parseFloat(distanceInput.value);
            
            if (isNaN(distance) || distance < 0) {
                showAlert('Please enter a valid distance', 'danger');
                return;
            }
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Find the active request for this driver
            fetch('/api/update_distance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    distance: distance,
                    csrf_token: csrfToken
                }),
                credentials: 'same-origin'
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while updating distance', 'danger');
            });
        }
        
        function updateDriverLocation(lat, lng) {
            const csrfToken = getCSRFToken();
            
            fetch('/api/update_driver_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                    csrf_token: csrfToken
                }),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update driver location:', data.message);
                    if (data.error === 'invalid_csrf') {
                        console.error('CSRF token validation failed');
                        // Optionally refresh the page to get a new CSRF token
                        window.location.reload();
                    }
                }
            })
            .catch(error => {
                console.error('Error updating driver location:', error);
            });
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add the alert to the page
            const container = document.querySelector('.container.mt-4');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }
        
        // Accept ambulance request with location and time input
        function acceptAmbulanceRequest(requestId) {
            console.log('acceptAmbulanceRequest called with ID:', requestId);
            
            if (!requestId) {
                console.error('No request ID provided');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Invalid request ID',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            Swal.fire({
                title: 'Accept Emergency Request',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Your Current Location:</label>
                            <input type="text" id="driverLocation" class="form-control" 
                                   placeholder="Enter your current location" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Distance to Patient (km):</label>
                            <input type="number" id="distanceToPatient" class="form-control" 
                                   placeholder="Enter distance" step="0.1" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estimated Time to Reach (minutes):</label>
                            <input type="number" id="estimatedTime" class="form-control" 
                                   placeholder="Enter estimated time" min="1" required>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Accept Request',
                confirmButtonColor: '#28a745',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    const driverLocation = document.getElementById('driverLocation').value.trim();
                    const distance = document.getElementById('distanceToPatient').value;
                    const estimatedTime = document.getElementById('estimatedTime').value;
                    
                    if (!driverLocation || !distance || !estimatedTime) {
                        Swal.showValidationMessage('All fields are required');
                        return false;
                    }
                    
                    if (parseFloat(distance) <= 0 || parseInt(estimatedTime) <= 0) {
                        Swal.showValidationMessage('Distance and time must be positive numbers');
                        return false;
                    }
                    
                    return fetch(`/api/ambulance-request/${requestId}/accept`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            driver_location: driverLocation,
                            distance: parseFloat(distance),
                            estimated_time: parseInt(estimatedTime)
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.message || 'Failed to accept request');
                        }
                        return data;
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`Error: ${error.message}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Request Accepted!',
                        text: 'You have accepted the emergency ambulance request.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.reload();
                    });
                }
            });
        }
        
        // Reject ambulance request
        function rejectAmbulanceRequest(requestId) {
            console.log('rejectAmbulanceRequest called with ID:', requestId);
            
            if (!requestId) {
                console.error('No request ID provided for reject');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Invalid request ID',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            Swal.fire({
                title: 'Reject Request?',
                text: 'Are you sure you want to reject this emergency request?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Reject',
                confirmButtonColor: '#dc3545',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/ambulance-request/${requestId}/reject`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'info',
                                title: 'Request Rejected',
                                text: 'The request has been rejected.',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            throw new Error(data.message || 'Failed to reject request');
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message || 'Failed to reject request',
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        }
</script>
{% endblock %}
